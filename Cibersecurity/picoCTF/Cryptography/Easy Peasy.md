#### Description

A one-time pad is unbreakable, but can you manage to recover the flag? (Wrap with picoCTF{}) `nc mercury.picoctf.net 58913` [otp.py](https://mercury.picoctf.net/static/e87ba627b72932bdb57b31bbac3c22c5/otp.py)

--------------------------------------------------
#### Hints 

Maybe there's a way to make this a 2x pad.

------------------------------------------------------

## Solution


First of all, what is OTP ?

An OTP (One Time Password) token is a secure hardware device that generates and stores cryptographic keys. OTPs, also known as dongles, generate a one-time security code that is generated by an algorithm.


We have a python file with this code:


```c
#!/usr/bin/python3 -u
import os.path

KEY_FILE = "key"
KEY_LEN = 50000
FLAG_FILE = "flag"


def startup(key_location):
        flag = open(FLAG_FILE).read()
        kf = open(KEY_FILE, "rb").read()

        start = key_location
        stop = key_location + len(flag)

        key = kf[start:stop]
        key_location = stop

        result = list(map(lambda p, k: "{:02x}".format(ord(p) ^ k), flag, key))
        print("This is the encrypted flag!\n{}\n".format("".join(result)))

        return key_location

def encrypt(key_location):
        ui = input("What data would you like to encrypt? ").rstrip()
        if len(ui) == 0 or len(ui) > KEY_LEN:
                return -1

        start = key_location
        stop = key_location + len(ui)

        kf = open(KEY_FILE, "rb").read()

        if stop >= KEY_LEN:
                stop = stop % KEY_LEN
                key = kf[start:] + kf[:stop]
        else:
                key = kf[start:stop]
        key_location = stop

        result = list(map(lambda p, k: "{:02x}".format(ord(p) ^ k), ui, key))

        print("Here ya go!\n{}\n".format("".join(result)))

        return key_location


print("******************Welcome to our OTP implementation!******************")
c = startup(0)
while c >= 0:
        c = encrypt(c)

```



When we enter to `nc mercury.picoctf.net 58913` we get this:

```
******************Welcome to our OTP implementation!******************
This is the encrypted flag!
51124f4d194969633e4b52026f4c07513a6f4d05516e1e50536c4954066a1c57

```

This site retrieves all the time the same input, somehow is recycling the OTP I think it is because of the lenght of the string that the flag has. 

I found a script that helps me to solve this problem , I didnt write this code, but this helped me to understand how it works.
```
from pwn import *

KEY_LEN = 50000
MAX_CHUNK = 1000

r = remote("mercury.picoctf.net", 20266)
r.recvuntil("This is the encrypted flag!\n")
flag = r.recvlineS(keepends = False)
log.info(f"Flag: {flag}")
bin_flag = unhex(flag)

counter = KEY_LEN - len(bin_flag)

with log.progress('Causing wrap-around') as p:
    while counter > 0:
        p.status(f"{counter} bytes left")
        chunk_size = min(MAX_CHUNK, counter)
        r.sendlineafter("What data would you like to encrypt? ", "a" * chunk_size)
        
        counter -= chunk_size

r.sendlineafter("What data would you like to encrypt? ", bin_flag)
r.recvlineS()
log.success("The flag: {}".format(unhex(r.recvlineS())))
```

So, when you execute this code you get the flag 
```
python3 ./solution.py 
[+] Opening connection to mercury.picoctf.net on port 58913: Done
/home/picoCTF/Easy Peasy/./solution.py:7: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  r.recvuntil("This is the encrypted flag!\n")
[*] Flag: 51124f4d194969633e4b52026f4c07513a6f4d05516e1e50536c4954066a1c57
[+] Causing wrap-around: Done
/home/picoCTF/Easy Peasy/./solution.py:18: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  r.sendlineafter("What data would you like to encrypt? ", "a" * chunk_size)
/home/.local/lib/python3.11/site-packages/pwnlib/tubes/tube.py:840: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  res = self.recvuntil(delim, timeout=timeout)
[+] The flag: b'35ecb423b3b43472c35cc2f41011c6d2'
[*] Closed connection to mercury.picoctf.net port 58913

```
